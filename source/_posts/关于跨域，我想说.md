---
title: 关于跨域，我想说.....
abbrlink: 9ff3
date: 2021-10-08 19:15:12
tags:
  - 前端开发
  - 面试题
categories: 
  - 前端知识积累
  - 网络相关
copyright: true
---

初始跨域的时候比较费解头疼，所以记录下来自己对跨域的理解。

<!-- more -->

## 什么是跨域？什么是浏览器同源政策？
>  跨域：
>​  	浏览器可能存放用户信息，为了保护用户信息，禁止非同源请求来获取本网站的信息，为了解决同源限制所作出的行为叫做跨域。
>  同源政策:
>    两个ip地址，只有符合以下三个条件时才可以叫做同源，同源的地址之间互相访问不存在跨域问题；
>    1.协议相同
>    2.域名相同
>    3.端口相同
>    只要有一个条件不符合，就会发生跨域问题。

```js
http://www.baidu.com/a   //http:默认端口是8080
https://www.baidu/com/b  //https:默认端口是443
A.同源 B.不同源，协议不同 C.不同源，端口不同 {D.不同源，协议和端口不同}
```

## 跨域方式有哪些？

```js
var xhr = new XMLHttpRequest();
xhr.open("get","https://suggest.taobao.com/sug?code=utf-8&q=%E8%BE%A3%E6%9D%A1");
xhr.send();

xhr.onreadystatechange = function(){
    if(xhr.readyState == 4){
         console.log(xhr.responseText);
       }
}
//这里会显示出现跨域阻止
```

### 跨域问题的第一种解决方式

这里以自己搭建的淘宝和京东后台模拟为例

* 1.淘宝

```js
//淘宝----------前端js代码
const xhr = new XMLHttpRequest();
//这里默认的请求地址是 http://localhost:8080/getInfo
// xhr.open("get","/getInfo");
//现在想要请求京东的资源
xhr.open("get","http://localhost:9000/getInfo");
xhr.send();
xhr.onreadystatechange = function (){
  if(xhr.readyState == 4){
    document.querySelector("span").innerText = xhr.responseText;
  }
}
```

```js
//淘宝----------后端js代码
const express = require("express");
const web = express();
web.use(express.static("public"));

web.get("/getInfo",function (req,res){
  const goodList = [
    {
      name : "雷神电脑",
      price : 9999
    },{
      name : "苹果手机",
      price : 6999
    },{
      name : "耐克球鞋",
      price : 999
    }
  ];
  res.send(goodList);
})

web.listen("8080",function (){
  console.log("8080端口启动");
})
```

* 京东

```js
//京东----------前端js代码 和淘宝的一致
//京东请求自己网站的数据，没有同源限制也就没有跨域问题
const xhr = new XMLHttpRequest();
  xhr.open("get","/getInfo");
  xhr.send();
  xhr.onreadystatechange = function (){
    if(xhr.readyState == 4){
      console.log(xhr.responseText);
      document.querySelector("span").innerText = xhr.responseText;
    }
  }
```

```js
//京东----------后端js代码
const express = require("express");
const web = express();
web.use(express.static("public"));

web.get("/getInfo",function (req,res){
  //-------------------------------------------------------- 
  res.set("Access-Control-Allow-Origin","http://localhost:8080")
  //-------------------------------------------------------- 
  const bookList = [
    {
      name : "海王",
      price : 99.99
    },{
      name : "海贼王",
      price : 699
    },{
      name : "海尔兄弟",
      price : 111
    }
  ];
  res.send(bookList);
})

web.listen("9000",function (){
  console.log("9000端口启动");
})
```

> 在这里，淘宝网站想要请求京东网站的资源时，发生了跨域请求。如果没有解决这个问题是没法请求到京东的数据的。
>
> 这里就有了第一种解决的方案，在京东的后端接口中声明，
>
> ```js
> res.set("Access-Control-Allow-Origin","希望可以被请求的地址")  
> //这里可以写* 代表所有的不同源的网站
> ```

总结：

```js
这里请求京东的资源会发生跨域请求,由于浏览器的同源限制，会拦截跨域请求
*  控制台输出：
*    已拦截跨源请求：同源策略禁止读取位于 http://localhost:9000/getInfo 的远程资源。
*    （原因：CORS 头缺少 'Access-Control-Allow-Origin'）。
*  只需要在对应的接口中设置：
*    res.set("Access-Control-Allow-Origin","希望可以被请求的地址")  这里可以写* 代表所有的不同源的网站
```

###  跨域问题的第二种解决方式

> 问题剖析：
>
> ​	跨域问题最根本产生的原因就是浏览器为了保护用户信息而设置了同源限制，只有同源的情况下才可以访问数据。同源限制也只是在浏览器中存在，在app等环境下运行就不会有同源限制，所以只需要想办法让请求发生不在浏览器中就可以。这里可以使用后台来请求外部资源，然后再返回给前端就可以解决跨域问题。

```html
<!-- 前端代码 -->
<body>
请输入您要查询的关键字：<input type="text" onblur="getInfo()">
<span></span>
<script>
  function getInfo() {
    const keywords = document.querySelector("input").value;
    const xhr = new XMLHttpRequest();
    //现在想要请求动态的资源,链接中的q参数是可变的，传入一个参数给后端
    xhr.open("get", "/getInfo?keyWords=" + keywords);
    xhr.send();
    xhr.onreadystatechange = function () {
      if (xhr.readyState == 4) {
        document.querySelector("span").innerText = xhr.responseText;
      }
    }
  }
</script>
</body>
```

```js
const express = require("express");
const web = express();
web.use(express.static("public"));
const https = require("https")

web.get("/getInfo", function (req, res) {
  const keywords = req.query.keyWords; // 这个keywords是一个汉字字符,拼接成的url是带有中文的，需要编码
  let url = "https://suggest.taobao.com/sug?code=utf-8&q=" + keywords;
  //https请求不能解析带有中文的地址
  url = encodeURI(url);
  //在这里请求外部数据
  //请求淘宝的一个搜索关键字的资源
  https.get(url, function (httpsRes) {
    let bufferData = "";
    httpsRes.on("data", function (data) {
      bufferData += data;
    });
    httpsRes.on("end", function () {
      //此时bufferData是一个buffer类型的数据
      bufferData = JSON.parse(bufferData);
      //将拼接到的资源返回给前端
      res.send(bufferData);
    })
  })
})

web.listen("8080", function () {
  console.log("8080端口启动");
})
```

### 跨域问题的第三种解决方式

> 在以往的html中，也有请求外部资源的时候

比如：

```html
<img src="地址" alt="">
<a href="地址"></a>
<link rel="stylesheet" href="地址">
<script src="地址"></script>
```

这些请求都可以请求成功，说明浏览器对于标签的外部资源请求是没有限制的，那么我们使用标签的形式进行请求跨域资源。

```html
<script>
  function myCallBack(data){
    console.log(data);
    //data里面存放了{result:[Array(数据)]}
  }
</script>
<script src="https://suggest.taobao.com/sug?code=utf-8&q=%E8%BE%A3%E6%9D%A1&callback=myCallBack"></script>
```


> 在标签中进行跨域请求就不需要在接口中增加一行 res.set("Access-Control-Allow-Origin","允许的对象")
> 也不需要通过后台的方式进行跨域请求
> 只需要在标签中声明请求的目标资源地址就可以了，更加方便
>
> 但是这种方式也有一个问题：
> 	怎么才能得到请求到的资源?
> 	这里需要给请求的资源地址后面添加一个callback 回调函数

### 跨域问题的第四个解决方式

> 搭配jquery中的dataType : jsonp解决跨域问题

```html
<script src="./jQuery.js"></script>
<script type="text/javascript">
  $.ajax({
    url : "https://suggest.taobao.com/sug?code=utf-8&q=%E8%BE%A3%E6%9D%A1",
    type : "get",
    dataType : "jsonP",
    success(res){
      console.log(res.result)
    }
  })
</script>
```

### 跨域问题的第五个解决方式（vue）

下面的例子中创建一个home.vue组件：

```vue
<template>
  <div>
    <button @click="sendQuest">发送跨域请求</button>
  </div>
</template>

<script>
// 这里需要安装axios模块 npm install axios
import axios from "axios"

export default {
  name: "home",
  methods: {
    sendQuest() {
      // 这里发生了跨域请求，请求不到数据。在config/index中进行配置
      // axios.get("https://suggest.taobao.com/sug?code=utf-8&q=%E9%A6%99%E6%B0%B4")
      axios.get("/taoBao/sug?code=utf-8&q=%E9%A6%99%E6%B0%B4")
      .then(function (data) {
        // 请求成功
        console.log(data);
      },function (err) {
        // 请求错误
        console.log(err);
      })
    }
  }
}
</script>

<style scoped>

</style>
<!-- 当点击按钮的时候进行数据跨域请求， -->
```

在config/index.js/dev/proxyTable中进行配置：

```js
// proxy 代理  table 表  代理表 
// vue当中使用代理表进行跨域  （反向代理）
// 代理表跨域 是把url当中相同的部分截取出来
proxyTable: {
  '/taoBao':{
    // target目标
     target:"https://suggest.taobao.com" , 
    //  是否改变请求源
     changeOrigin:true , 
    //  路径重写
     pathRewrite:{
        '^/taoBao':""
     }
  }
},
```

> 这样就可以实现vue中的跨域请求


